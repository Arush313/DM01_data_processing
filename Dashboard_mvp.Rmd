---
title: "Diagnostic weekly dashboard"
output: 
  flexdashboard::flex_dashboard:
    theme:
      bg: "#FFFFFF"
      fg: "#320871" 
      primary: "#A32C74"
      base_font:
        google: Prompt
      code_font:
        google: JetBrains Mono
    orientation: columns
    vertical_layout: fill
params:
  report_date: 20240501
  duration: 30
---

```{r setup, include=FALSE}

source('src/functions.R')
# Data ingestion
data = read_csv('data/inter.csv')
# Install thematic and un-comment for themed static plots (i.e., ggplot2)
# thematic::thematic_rmd()
```

All diagnostics
=====================================

## Column {.tabset data-width="650"}

### Chart A

```{r}

```

### Chart B

```{r}

```

## Column {data-width="350"}

### Chart C

```{r}

```

### Chart D

```{r}

```

Endoscopy
=====================================
## Column {.tabset data-width="650"}

### Chart A

```{r}

```

### Chart B

```{r}

```

## Column {data-width="350"}

### Chart C

```{r}
# Filter data
filtered_data = filter_plot_data(data = data, speciality_group = 'Endoscopy', indicator = 'diagnostic_waiting_list', report_date = params$report_date, duration = params$duration)

# Calculate metric
aggregated_data = filtered_data %>%
  filter(Description == 'total')%>%
  group_by(Date, Provider) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() 

# Plot data
plot = line_plot_time(aggregated_data, Provider, 'Number of cases', 'Diagnostic 6+ Week waits per provider')
ggplotly(plot)
```

### Chart D

```{r}
# Filter data
filtered_data = filter_plot_data(data = data, speciality_group = 'Endoscopy', report_date = params$report_date, duration = params$duration)

# Calculate metric
aggregated_data = filtered_data %>%
  filter(Indicator %in% c('diagnostic_waiting_list', 'wait_list'), 
         !str_detect(Description, 'tci')) %>%
  mutate(
    Length = case_when(
      Description == 'total' ~ 'Over_Six',
      str_detect(Description, 'weeks') ~ 'Under_Six'
    )
  ) %>%
  group_by(Date, Length) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() %>%
  pivot_wider(id_cols = Date, names_from = Length, values_from = Activity) %>%
  mutate(Total = Over_Six + Under_Six,
         Prop_over_six = round(Over_Six/Total*100,0)) 

# Plot data
coeff <- 40

plot = ggplot(aggregated_data, aes(x=Date, y = Over_Six, label = paste0(Over_Six, '\n(', Prop_over_six, '%)'))) +
  geom_bar( stat="identity", fill =  "#1B9B9D") + 
  geom_text(size = 11, position = position_stack(vjust=0.5), colour = 'white')+
  geom_line( aes(y=Prop_over_six*coeff), color = "#005EB8") +
   scale_y_continuous(
    
    # Features of the first axis
    name = "Absolute Number",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~./coeff, name="%")
  ) + 
  theme_nclicb()+
  ggtitle('Whatever this is supposed to show...')+
  theme(legend.position = 'none',
       #'   text = element_text(size = 40)
         )

ggplotly(plot)

```
Imaging
=====================================