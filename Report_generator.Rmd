---
title: "Report_generation"
output: html_document
date: "2024-06-14"
params:
  report_date: 20240201
  duration: 30
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source('src/functions.R')

```

# Report overview
## Scope

## Data sources

## Process

## Limitations

# Setup

Functions:
- Ingesting intermediate data from a dummy file. This will change to ingestion from the sandpit.
- Ingesting the template file
- Deleting any preexisting output
- Initialising the presentation opject

```{r}
# Data ingestion
data = read_csv('inter.csv')

# Ingest and initiaise blank presentation
template_presentation <- read_pptx('input/template.pptx') 

```

# Building Presentation

Proposed structure is sub heading per slide, with one chunk per slide element

### Title slide

```{r}

Presentation <- template_presentation %>%
  add_slide(layout = "With Image_Date/name one line", master = "Presentation Title Slides") %>%
  ph_with(my_pres, value = "Diagnostic Weekly Assessment Report", location = ph_location_type(type = "title")) 

```

## Endoscopy

### Endoscopy KPI table (SLIDE)

### Endoscopy visualisation (SLIDE)

#### Endoscopy performance - Total waiting list 
```{r}
# Filter data
filtered_data = filter_plot_data(data = data, speciality_group = 'Endoscopy', report_date = params$report_date, duration = params$duration)

# Calculate metric
aggregated_data = filtered_data %>%
  filter(Indicator %in% c('diagnostic_waiting_list', 'wait_list'), 
         !str_detect(Description, 'tci')) %>%
  mutate(
    Length = case_when(
      Description == 'total' ~ 'Over_Six',
      str_detect(Description, 'weeks') ~ 'Under_Six'
    )
  ) %>%
  group_by(Date, Length) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() %>%
  pivot_wider(id_cols = Date, names_from = Length, values_from = Activity) %>%
  mutate(Total = Over_Six + Under_Six,
         Prop_over_six = round(Over_Six/Total*100,0)) 

# Plot data
coeff <- 40

plot = ggplot(aggregated_data, aes(x=Date, y = Over_Six, label = paste0(Over_Six, '\n(', Prop_over_six, '%)'))) +
  geom_bar( stat="identity", fill =  "#1B9B9D") + 
  geom_text(size = 11, position = position_stack(vjust=0.5), colour = 'white')+
  geom_line( aes(y=Prop_over_six*coeff), color = "#005EB8") +
   scale_y_continuous(
    
    # Features of the first axis
    name = "Absolute Number",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~./coeff, name="%")
  ) + 
  theme_nclicb()+
  ggtitle('Whatever this is supposed to show...')+
  theme(legend.position = 'none',
          text = element_text(size = 40)
         )


# Embed data in slide
Presentation <- Presentation %>%
  add_slide(layout = "Two Columns Style 1", master = "Content Slide White")  %>%
  ph_with(value = plot, location = ph_location_label(ph_label = "Content Placeholder 2"))

```

#### Endoscopy performance - Waiting list by provider 
```{r}
# Filter data
filtered_data = filter_plot_data(data = data, speciality_group = 'Endoscopy', indicator = 'diagnostic_waiting_list', report_date = params$report_date, duration = params$duration)

# Calculate metric
aggregated_data = filtered_data %>%
  filter(Description == 'total')%>%
  group_by(Date, Provider) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() 

# Plot data
plot = line_plot_time(aggregated_data, Provider, 'Number of people', 'Diagnostic 6+ Week waits per provider')

# Embed data in slide
Presentation <- Presentation%>% 
  ph_with(value = plot, location = ph_location_label(ph_label = "Content Placeholder 3"))
```

```{r}
Presentation %>%
  print(target = paste0('output/diagnostic_report_data_', params$report_date, '.pptx'))

```


## Reference information

```{r echo=FALSE, eval = FALSE}

layouts <- layout_summary(my_pres)

print_placeholders <- function(layout_name, master_name){
  placeholders <- layout_properties(my_pres, layout = layout_name, master = master_name)
  print(paste("PLaceholders:", layout_name, master_name))
  print(placeholders)
}

walk2(.x = layouts$layout, .y = layouts$master, ~print_placeholders(.x, .y))

layout_properties(my_pres, layout = "Two Columns Style 1", master = "Content Slide White")

#ggsave('review.png', plot)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
