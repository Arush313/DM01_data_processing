---
title: "Report_generation"
output: html_document
date: "2024-06-14"
params:
  report_date: 20240501
  duration: 30
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source('src/functions.R')

```

# Report overview
## Scope

## Data sources

## Process

## Limitations

# Setup

Functions:
- Ingesting intermediate data from a dummy file. This will change to ingestion from the sandpit.
- Ingesting the template file
- Deleting any preexisting output
- Initialising the presentation object

```{r}
# Data ingestion
data = read_csv('data/inter.csv')

# Ingest and initiaise blank presentation
template_presentation <- read_pptx('input/template.pptx') 

```


## Connecting to the Sandpit

```{r}

con <- dbConnect(odbc::odbc(), 
                 dsn = "SANDPIT",
                 database = "Data_Lab_NCL",
                 TrustedConnection = TRUE)


# Parameters from header
start_date <- (params$report_date)
end_date <- start_date + params$duration

# Retrieve data from the table

# data <- dbReadTable(con, "table_name")


# Code for executing a specific query instead - commented out

# Construct the SQL query using string concatenation

query <- paste0("
  SELECT *
  FROM table_name
  WHERE ReportDate BETWEEN '", start_date, "' AND '", end_date, "'
  ORDER BY ReportDate DESC
")

# Execute the query and retrieve the data
data <- dbGetQuery(con, query)

# Close the database connection
dbDisconnect(con)
```


# Building Presentation

Proposed structure is sub heading per slide, with one chunk per slide element

### Title slide

```{r}

Presentation <- template_presentation %>%
  add_slide(layout = "With Image_Date/name one line", master = "Presentation Title Slides") %>%
  ph_with(my_pres, value = "Diagnostic Weekly Assessment Report", location = ph_location_type(type = "title")) 

```

## Endoscopy

### Endoscopy KPI table (SLIDE)

### Endoscopy visualisation (SLIDE)

#### Endoscopy performance - Total waiting list 
```{r}
# Filter data
filtered_data = filter_plot_data(data = data, speciality_group = 'Endoscopy', report_date = params$report_date, duration = params$duration)

# Calculate metric
aggregated_data = filtered_data %>%
  filter(Indicator %in% c('diagnostic_waiting_list', 'wait_list'), 
         !str_detect(Description, 'tci')) %>%
  mutate(
    Length = case_when(
      Description == 'total' ~ 'Over_Six',
      str_detect(Description, 'weeks') ~ 'Under_Six'
    )
  ) %>%
  group_by(Date, Length) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() %>%
  pivot_wider(id_cols = Date, names_from = Length, values_from = Activity) %>%
  mutate(Total = Over_Six + Under_Six,
         Prop_over_six = round(Over_Six/Total*100,0)) 

# Plot data
coeff <- 40

plot = ggplot(aggregated_data, aes(x=Date, y = Over_Six, label = paste0(Over_Six, '\n(', Prop_over_six, '%)'))) +
  geom_bar( stat="identity", fill =  "#1B9B9D") + 
  geom_text(size = 11, position = position_stack(vjust=0.5), colour = 'white')+
  geom_line( aes(y=Prop_over_six*coeff), color = "#005EB8") +
   scale_y_continuous(
    
    # Features of the first axis
    name = "Absolute Number",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~./coeff, name="%")
  ) + 
  theme_nclicb()+
  ggtitle('Whatever this is supposed to show...')+
  theme(legend.position = 'none',
          text = element_text(size = 40)
         )


# Embed data in slide
Presentation <- Presentation %>%
  add_slide(layout = "Two Columns Style 1", master = "Content Slide White")  %>%
  ph_with(value = plot, location = ph_location_label(ph_label = "Content Placeholder 2"))

```

#### Endoscopy performance - Waiting list by provider 
```{r}
# Filter data
filtered_data = filter_plot_data(data = data, speciality_group = 'Endoscopy', indicator = 'diagnostic_waiting_list', report_date = params$report_date, duration = params$duration)

# Calculate metric
aggregated_data = filtered_data %>%
  filter(Description == 'total')%>%
  group_by(Date, Provider) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() 

# Plot data
plot = line_plot_time(aggregated_data, Provider, 'Number of cases', 'Diagnostic 6+ Week waits per provider')

# Embed data in slide
Presentation <- Presentation%>% 
  ph_with(value = plot, location = ph_location_label(ph_label = "Content Placeholder 3"))
```




## Imaging Performance

```{r}
# Filter data
imaging_data = filter_plot_data(data = data, speciality_group = 'Imaging', report_date = params$report_date, duration = params$duration)

# Calculate metric
aggregated_data = imaging_data %>%
  filter(Indicator %in% c('diagnostic_waiting_list', 'wait_list'), 
         !str_detect(Description, 'tci')) %>%
  mutate(
    Length = case_when(
      Description == 'total' ~ 'Over_Six',
      str_detect(Description, 'weeks') ~ 'Under_Six'
    )
  ) %>%
  group_by(Date, Length) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() %>%
  pivot_wider(id_cols = Date, names_from = Length, values_from = Activity) %>%
  mutate(Total = Over_Six + Under_Six,
         Prop_over_six = round(Over_Six/Total*100,0)) 

# Plot data
coeff <- 40

plot = ggplot(aggregated_data, aes(x=Date, y = Over_Six, label = paste0(Over_Six, '\n(', Prop_over_six, '%)'))) +
  geom_bar( stat="identity", fill =  "#1B9B9D") + 
  geom_text(size = 11, position = position_stack(vjust=0.5), colour = 'white')+
  geom_line( aes(y=Prop_over_six*coeff), color = "#005EB8") +
   scale_y_continuous(
    
    # Features of the first axis
    name = "Cases",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~./coeff, name="%")
  ) + 
  theme_nclicb()+
  ggtitle('NCL Diagnostic Performance - Actual and Wating %')+
  theme(legend.position = 'none',
          text = element_text(size = 40)
         )


# Embed data in slide
Presentation <- Presentation %>%
  add_slide(layout = "Two Columns Style 1", master = "Content Slide White")  %>%
  ph_with(value = plot, location = ph_location_label(ph_label = "Content Placeholder 2"))



# Calculate metric
aggregated_data = imaging_data %>%
  filter(Description == 'total')%>%
  group_by(Date, Provider) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() 

# Plot data
plot = line_plot_time(aggregated_data, Provider, 'Number of cases', 'Diagnostic 6+ Week waits per provider')

Presentation <- Presentation%>% 
  ph_with(value = plot, location = ph_location_label(ph_label = "Content Placeholder 3"))

```


#### Imaging Backlog By Provider


```{r}


filtered_data2 <- imaging_data %>% 
  filter(Description == 'total')

# Summarize and reshape the data
data_summary <- filtered_data2 %>%
  group_by(Provider, Speciality) %>%
  summarize(Total_Activity = sum(Activity, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(names_from = Speciality, values_from = Total_Activity, values_fill = 0)

# Calculate the total row
total_row <- data_summary %>%
  summarize(across(where(is.numeric), sum, na.rm = TRUE)) %>%
  mutate(Provider = "NCL")

# Calculate percentages
data_percentage <- data_summary %>%
  mutate(across(where(is.numeric), ~ . / sum(.) * 100))

# Combine the percentage data with the total row
final_table <- bind_rows(data_percentage, total_row) %>%
  mutate(across(where(is.numeric), ~ ifelse(Provider == "NCL", ., sprintf("%.2f%%", .))))


summary_table <- xtable(final_table)

# Add table to ppt
Presentation <- Presentation %>%
  add_slide(layout = "Image Style 1", master = "Content Slide White")  %>%
  ph_with(value = final_table, location = ph_location_label(ph_label = "Graphic 5"))

```





#### Waiting list trend by Provider

```{r}


prov_plot = ggplot(aggregated_data, aes(y = Activity, x = Date, color = Provider)) +
  geom_line(na.rm = TRUE) +
  geom_point(na.rm = TRUE) +
  scale_x_date(date_breaks = "1 week", date_labels = "%d-%m-%Y") +
  labs(
    title = "Imaging waiting list trend by provider",
    x = "Date"
  ) +
  facet_wrap(~ Provider) +
  theme_nclicb() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_colour_ncl() 

Presentation <- Presentation %>%
  add_slide(layout = "Two Columns Style 1", master = "Content Slide White")  %>%
  ph_with(value = prov_plot, location = ph_location_label(ph_label = "Content Placeholder 2"))

prov_plot2 = line_plot_time(aggregated_data, Provider, 'Number of cases', 'Diagnostic 6+ Week waits per provider') +
  facet_wrap(~ Provider)

Presentation <- Presentation%>% 
  ph_with(value = prov_plot2, location = ph_location_label(ph_label = "Content Placeholder 3"))
```



## Inhealth Performance

```{r}
inhealth_data <- filter_plot_data(data = data, provider = 'InHealth', indicator = 'diagnostic_waiting_list', report_date = params$report_date, duration = params$duration + 60)

inhealth_data <- inhealth_data %>% 
  filter(Speciality == c('Magnetic Resonance Imaging', 'Non-obstetric Ultrasound', 'DEXA Scan', 'Cardiology - Echocardiography'), 
         Description == 'total')

inh_plot <- line_plot_time(inhealth_data, Speciality, 'Number of cases', 'Wait by provider_') +
  facet_wrap(~ Speciality)

print(inh_plot)
```

#### Creating a table for InHealth data

```{r}


# Pivot the data to wide format
data_wide <- inhealth_data %>%
  mutate(Week = lubridate::floor_date(Date, "week")) %>%
  group_by(Provider, Speciality, Week) %>%
  summarize(Activity = sum(Activity), .groups = 'drop') %>%
  pivot_wider(names_from = Week, values_from = Activity, values_fill = 0) %>%
  ungroup()

# Define the path for the temporary HTML file and the image file
html_file <- tempfile(fileext = ".html")
png_file <- tempfile(fileext = ".png")


# Convert data_wide to gt table
gt_table <- inhealth_data %>%
  gt() %>%
  tab_header(
    title = "Activity Numbers"
  ) %>%
  cols_label(
    Provider = "Provider",
    Speciality = "Speciality"
  ) %>%
  fmt_number(
    columns = starts_with("202"),
    decimals = 0
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "lightblue")
    ),
    locations = cells_body(
      columns = starts_with("202")
    )
  )


gt_table2 <- create_wide_table(data_wide, "Activity Numbers")


gtsave(gt_table2, html_file)

webshot(html_file, file = png_file)


Presentation <- Presentation %>%
  add_slide(layout = "Title and Content", master = "Office Theme") %>%
  ph_with(value = external_img(png_file), location = ph_location_label(ph_label = "Content Placeholder 2"))


```



## Code for automation of generic information


```{r}

# Aggregate data by Date
aggregate_data <- aggregated_data %>%
  group_by(Date) %>%
  summarise(
    TotalActivity = sum(Activity),
    AverageActivity = mean(Activity),
    MaxActivity = max(Activity)
  ) %>%
  arrange(Date) %>%
  ungroup()

# Function to generate aggregate sentence
generate_aggregate_sentence <- function(df) {
  sentences <- paste(
    "For the week ending", format(df$Date, "%d/%m/%Y"),
    ", the total activity was", df$TotalActivity,
    "with an average activity of", df$AverageActivity,
    "and a maximum activity of", df$MaxActivity, "."
  )
  return(sentences)
}

# Generate aggregate sentences
aggregate_sentences <- lapply(1:nrow(aggregate_data), function(i) {
  generate_aggregate_sentence(aggregate_data[i, ])
})


print(aggregate_sentences)

```


#### Imaging sentences 

```{r}

# Filter data
filtered_data = filter_plot_data(data = data, speciality_group = 'Imaging', report_date = params$report_date, duration = params$duration +600)

# Calculate metric
aggregated_data = filtered_data %>%
  filter(Indicator %in% c('diagnostic_waiting_list', 'wait_list'), 
         !str_detect(Description, 'tci')) %>%
  mutate(
    Length = case_when(
      Description == 'total' ~ 'Over_Six',
      str_detect(Description, 'weeks') ~ 'Under_Six'
    )
  ) %>%
  group_by(Date, Length) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() %>%
  pivot_wider(id_cols = Date, names_from = Length, values_from = Activity) %>%
  mutate(Total = Over_Six + Under_Six,
         Prop_over_six = round(Over_Six/Total*100,0)) 





# Function to generate sentences
generate_sentences <- function(data) {
  # Ensure data is sorted by Date
  data <- data %>% arrange(Date)
  
  # Calculate changes
  data <- data %>%
    mutate(
      PreviousWeekTotal = lag(Total),
      TotalChange = Total - PreviousWeekTotal,
      TotalChangePercent = (TotalChange / PreviousWeekTotal) * 100,
      
      PreviousWeekOverSix = lag(Over_Six),
      OverSixChange = Over_Six - PreviousWeekOverSix,
      OverSixChangePercent = (OverSixChange / PreviousWeekOverSix) * 100,
      
      PreviousWeekPropOverSix = lag(Prop_over_six),
      PropOverSixChange = Prop_over_six - PreviousWeekPropOverSix
    ) %>%
    filter(!is.na(PreviousWeekTotal))  # Remove rows where PreviousWeekTotal is NA
  
  # Get the latest week data
  latest_week_data <- data %>%
    filter(Date == max(Date))
  
  # Determine the wording based on the change
  total_change_word <- ifelse(latest_week_data$TotalChange >= 0, "increased", "decreased")
  over_six_change_word <- ifelse(latest_week_data$OverSixChange >= 0, "increased", "decreased")
  
  # Generate sentences for the latest week
  sentences <- list(
    paste("For the week ending", format(latest_week_data$Date, "%d/%m/%Y"), ", the total imaging waiting list", total_change_word, "by",
          format(abs(latest_week_data$TotalChange), big.mark = ",", scientific = FALSE), "to",
          format(latest_week_data$Total, big.mark = ",", scientific = FALSE), 
          "(", ifelse(latest_week_data$TotalChangePercent > 0, "+", ""), 
          round(latest_week_data$TotalChangePercent, 1), "%) compared to the previous week."),
    
    paste("The number of patients waiting over 6 weeks", over_six_change_word, "by", 
          format(abs(latest_week_data$OverSixChange), big.mark = ",", scientific = FALSE), "to", 
          format(latest_week_data$Over_Six, big.mark = ",", scientific = FALSE), ". Over 6-week wait, performance", 
          ifelse(latest_week_data$OverSixChangePercent >= 0, "increased", "decreased"), "by",
          round(abs(latest_week_data$OverSixChangePercent), 1), "% to",
          round(latest_week_data$Prop_over_six, 1), "%.")
  )
  
  return(sentences)
}

# Generate sentences for the sample data
sentences_list <- generate_sentences(aggregated_data)
print(sentences_list)

```






```{r}
Presentation %>%
  print(target = paste0('output/diagnostic_report_data_', params$report_date, '.pptx'))

```



# Closing the Sandpit connection

```{r}

# dbDisconnect(con)

```


## Reference information

```{r echo=FALSE, eval = FALSE}

layouts <- layout_summary(template_presentation)

print_placeholders <- function(layout_name, master_name){
  placeholders <- layout_properties(template_presentation, layout = layout_name, master = master_name)
  print(paste("PLaceholders:", layout_name, master_name))
  print(placeholders)
}

walk2(.x = layouts$layout, .y = layouts$master, ~print_placeholders(.x, .y))

layout_properties(template_presentation, layout = "Two Columns Style 1", master = "Content Slide White")

#ggsave('review.png', plot)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
