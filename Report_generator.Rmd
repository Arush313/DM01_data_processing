---
title: "Report_generation"
output: html_document
date: "2024-06-14"
params:
  report_date: 20240501
  duration: 30
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source('src/functions.R')

```

# Report overview
## Scope

## Data sources

## Process

## Limitations

# Setup

Functions:
- Ingesting intermediate data from a dummy file. This will change to ingestion from the sandpit.
- Ingesting the template file
- Deleting any preexisting output
- Initialising the presentation object

```{r}
# Data ingestion
data = read_csv('data/inter.csv')

# Ingest and initiaise blank presentation
template_presentation <- read_pptx('input/template.pptx') 

```


## Connecting to the Sandpit

```{r}

# Retrieve data from the desired table

# data <- dbReadTable(con, "table_name")


# Code for executing a specific query instead - commented out

# query <- "SELECT * FROM table_name WHERE specific_date = date"

# data <- dbGetQuery(con, query)

```


# Building Presentation

Proposed structure is sub heading per slide, with one chunk per slide element

### Title slide

```{r}

Presentation <- template_presentation %>%
  add_slide(layout = "With Image_Date/name one line", master = "Presentation Title Slides") %>%
  ph_with(my_pres, value = "Diagnostic Weekly Assessment Report", location = ph_location_type(type = "title")) 

```

## Endoscopy

### Endoscopy KPI table (SLIDE)

### Endoscopy visualisation (SLIDE)

#### Endoscopy performance - Total waiting list 
```{r}
# Filter data
filtered_data = filter_plot_data(data = data, speciality_group = 'Endoscopy', report_date = params$report_date, duration = params$duration)

# Calculate metric
aggregated_data = filtered_data %>%
  filter(Indicator %in% c('diagnostic_waiting_list', 'wait_list'), 
         !str_detect(Description, 'tci')) %>%
  mutate(
    Length = case_when(
      Description == 'total' ~ 'Over_Six',
      str_detect(Description, 'weeks') ~ 'Under_Six'
    )
  ) %>%
  group_by(Date, Length) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() %>%
  pivot_wider(id_cols = Date, names_from = Length, values_from = Activity) %>%
  mutate(Total = Over_Six + Under_Six,
         Prop_over_six = round(Over_Six/Total*100,0)) 

# Plot data
coeff <- 40

plot = ggplot(aggregated_data, aes(x=Date, y = Over_Six, label = paste0(Over_Six, '\n(', Prop_over_six, '%)'))) +
  geom_bar( stat="identity", fill =  "#1B9B9D") + 
  geom_text(size = 11, position = position_stack(vjust=0.5), colour = 'white')+
  geom_line( aes(y=Prop_over_six*coeff), color = "#005EB8") +
   scale_y_continuous(
    
    # Features of the first axis
    name = "Absolute Number",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~./coeff, name="%")
  ) + 
  theme_nclicb()+
  ggtitle('Whatever this is supposed to show...')+
  theme(legend.position = 'none',
          text = element_text(size = 40)
         )


# Embed data in slide
Presentation <- Presentation %>%
  add_slide(layout = "Two Columns Style 1", master = "Content Slide White")  %>%
  ph_with(value = plot, location = ph_location_label(ph_label = "Content Placeholder 2"))

```

#### Endoscopy performance - Waiting list by provider 
```{r}
# Filter data
filtered_data = filter_plot_data(data = data, speciality_group = 'Endoscopy', indicator = 'diagnostic_waiting_list', report_date = params$report_date, duration = params$duration)

# Calculate metric
aggregated_data = filtered_data %>%
  filter(Description == 'total')%>%
  group_by(Date, Provider) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() 

# Plot data
plot = line_plot_time(aggregated_data, Provider, 'Number of cases', 'Diagnostic 6+ Week waits per provider')

# Embed data in slide
Presentation <- Presentation%>% 
  ph_with(value = plot, location = ph_location_label(ph_label = "Content Placeholder 3"))
```




## Imaging Performance

```{r}
# Filter data
imaging_data = filter_plot_data(data = data, speciality_group = 'Imaging', report_date = params$report_date, duration = params$duration)

# Calculate metric
aggregated_data = imaging_data %>%
  filter(Indicator %in% c('diagnostic_waiting_list', 'wait_list'), 
         !str_detect(Description, 'tci')) %>%
  mutate(
    Length = case_when(
      Description == 'total' ~ 'Over_Six',
      str_detect(Description, 'weeks') ~ 'Under_Six'
    )
  ) %>%
  group_by(Date, Length) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() %>%
  pivot_wider(id_cols = Date, names_from = Length, values_from = Activity) %>%
  mutate(Total = Over_Six + Under_Six,
         Prop_over_six = round(Over_Six/Total*100,0)) 

# Plot data
coeff <- 40

plot = ggplot(aggregated_data, aes(x=Date, y = Over_Six, label = paste0(Over_Six, '\n(', Prop_over_six, '%)'))) +
  geom_bar( stat="identity", fill =  "#1B9B9D") + 
  geom_text(size = 11, position = position_stack(vjust=0.5), colour = 'white')+
  geom_line( aes(y=Prop_over_six*coeff), color = "#005EB8") +
   scale_y_continuous(
    
    # Features of the first axis
    name = "Cases",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~./coeff, name="%")
  ) + 
  theme_nclicb()+
  ggtitle('NCL Diagnostic Performance - Actual and Wating %')+
  theme(legend.position = 'none',
          text = element_text(size = 40)
         )


# Embed data in slide
Presentation <- Presentation %>%
  add_slide(layout = "Two Columns Style 1", master = "Content Slide White")  %>%
  ph_with(value = plot, location = ph_location_label(ph_label = "Content Placeholder 2"))



# Calculate metric
aggregated_data = imaging_data %>%
  filter(Description == 'total')%>%
  group_by(Date, Provider) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() 

# Plot data
plot = line_plot_time(aggregated_data, Provider, 'Number of cases', 'Diagnostic 6+ Week waits per provider')

Presentation <- Presentation%>% 
  ph_with(value = plot, location = ph_location_label(ph_label = "Content Placeholder 3"))

```


#### Imaging Backlog By Provider


```{r}


filtered_data2 <- imaging_data %>% 
  filter(Description == 'total')

# Summarize and reshape the data
data_summary <- filtered_data2 %>%
  group_by(Provider, Speciality) %>%
  summarize(Total_Activity = sum(Activity, na.rm = TRUE), .groups = 'drop') %>%
  pivot_wider(names_from = Speciality, values_from = Total_Activity, values_fill = 0)

# Calculate the total row
total_row <- data_summary %>%
  summarize(across(where(is.numeric), sum, na.rm = TRUE)) %>%
  mutate(Provider = "NCL")

# Calculate percentages
data_percentage <- data_summary %>%
  mutate(across(where(is.numeric), ~ . / sum(.) * 100))

# Combine the percentage data with the total row
final_table <- bind_rows(data_percentage, total_row) %>%
  mutate(across(where(is.numeric), ~ ifelse(Provider == "NCL", ., sprintf("%.2f%%", .))))


summary_table <- xtable(final_table)

# Add table to ppt
Presentation <- Presentation %>%
  add_slide(layout = "Image Style 1", master = "Content Slide White")  %>%
  ph_with(value = final_table, location = ph_location_label(ph_label = "Graphic 5"))

```





#### Waiting list trend by Provider

```{r}


prov_plot = ggplot(aggregated_data, aes(y = Activity, x = Date, color = Provider)) +
  geom_line(na.rm = TRUE) +
  geom_point(na.rm = TRUE) +
  scale_x_date(date_breaks = "1 week", date_labels = "%d-%m-%Y") +
  labs(
    title = "Imaging waiting list trend by provider",
    x = "Date"
  ) +
  facet_wrap(~ Provider) +
  theme_nclicb() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_colour_ncl() 

Presentation <- Presentation %>%
  add_slide(layout = "Two Columns Style 1", master = "Content Slide White")  %>%
  ph_with(value = prov_plot, location = ph_location_label(ph_label = "Content Placeholder 2"))

prov_plot2 = line_plot_time(aggregated_data, Provider, 'Number of cases', 'Diagnostic 6+ Week waits per provider') +
  facet_wrap(~ Provider)

Presentation <- Presentation%>% 
  ph_with(value = prov_plot2, location = ph_location_label(ph_label = "Content Placeholder 3"))
```



## Inhealth Performance

```{r}
inhealth_data <- filter_plot_data(data = data, provider = 'InHealth', indicator = 'diagnostic_waiting_list', report_date = params$report_date, duration = params$duration + 60)

inhealth_data <- inhealth_data %>% 
  filter(Speciality == c('Magnetic Resonance Imaging', 'Non-obstetric Ultrasound', 'DEXA Scan', 'Cardiology - Echocardiography'), 
         Description == 'total')

inh_plot <- line_plot_time(inhealth_data, Speciality, 'Number of cases', 'Wait by provider_') +
  facet_wrap(~ Speciality)

print(inh_plot)
```

#### Creating a table for InHealth data

```{r}


# Pivot the data to wide format
data_wide <- inhealth_data %>%
  mutate(Week = lubridate::floor_date(Date, "week")) %>%
  group_by(Provider, Speciality, Week) %>%
  summarize(Activity = sum(Activity), .groups = 'drop') %>%
  pivot_wider(names_from = Week, values_from = Activity, values_fill = 0) %>%
  ungroup()




# Convert data_wide to gt table
gt_table <- inhealth_data %>%
  gt() %>%
  tab_header(
    title = "Activity Numbers"
  ) %>%
  cols_label(
    Provider = "Provider",
    Speciality = "Speciality"
  ) %>%
  fmt_number(
    columns = starts_with("202"),
    decimals = 0
  ) %>%
  tab_style(
    style = list(
      cell_fill(color = "lightgray")
    ),
    locations = cells_body(
      columns = starts_with("202")
    )
  )



gt_table2 <- create_wide_table(data_wide, "Activity Numbers")

print(gt_table2)
```



## Code for automation of generic information


```{r}

# Aggregate data by Date
aggregate_data <- aggregated_data %>%
  group_by(Date) %>%
  summarise(
    TotalActivity = sum(Activity),
    AverageActivity = mean(Activity),
    MaxActivity = max(Activity)
  ) %>%
  arrange(Date) %>%
  ungroup()

# Function to generate aggregate sentence
generate_aggregate_sentence <- function(df) {
  sentences <- paste(
    "For the week ending", format(df$Date, "%d/%m/%Y"),
    ", the total activity was", df$TotalActivity,
    "with an average activity of", df$AverageActivity,
    "and a maximum activity of", df$MaxActivity, "."
  )
  return(sentences)
}

# Generate aggregate sentences
aggregate_sentences <- lapply(1:nrow(aggregate_data), function(i) {
  generate_aggregate_sentence(aggregate_data[i, ])
})


print(aggregate_sentences)

```


#### Generic sentences 


```{r}

# Aggregate data by Date
aggregate_data <- aggregated_data %>%
  group_by(Date) %>%
  summarise(
    TotalActivity = sum(Activity)
  ) %>%
  arrange(Date) %>%
  ungroup()

# Function to generate sentences
generate_sentences <- function(df) {
  previous_week <- lag(df$TotalActivity)
  previous_week_change <- df$TotalActivity - previous_week
  previous_week_change_percent <- (previous_week_change / previous_week) * 100
  avg_activity_last_year <- mean(df$TotalActivity) / mean(df$TotalActivity - 52)

  sentences <- list(
    paste("For the w/e", format(df$Date, "%d/%m/%Y"), ", the total activity was", 
          format(df$TotalActivity, big.mark = ",", scientific = FALSE), "."),
    paste("The number of patients waiting over 6 weeks increased by", 
          format(previous_week_change, big.mark = ","), "to", 
          format(df$TotalActivity, big.mark = ","), ". Over 6-week wait, performance increased by", 
          round(previous_week_change_percent, 1), "% to", round(avg_activity_last_year, 1), "%."),
    paste("Activity reduced by", format(previous_week_change, big.mark = ","), 
          "to", format(df$TotalActivity, big.mark = ","), "from the previous week. The 4-week average activity was",
          round(avg_activity_last_year, 1), "% compared to last year (same week).")
  )
  
  return(sentences)
}

# Generate sentences for each week
sentences_list <- generate_sentences(aggregate_data)

print(sentences_list)
```






```{r}

# Filter data
filtered_data = filter_plot_data(data = data, speciality_group = 'Imaging', indicator = 'diagnostic_waiting_list', report_date = params$report_date, duration = 6000)

# Calculate metric
aggregated_data = filtered_data %>%
  filter(Description == 'total')%>%
  group_by(Date, Provider) %>%
  summarise(Activity = sum(Activity)) %>%
  ungroup() 


# Aggregate data by Date
aggregate_data <- aggregated_data %>%
  group_by(Date) %>%
  summarise(
    TotalActivity = sum(Activity)
  ) %>%
  arrange(Date) %>%
  ungroup()

# Function to generate sentences for the most recent date
generate_sentences <- function(df) {
  # Sort data by Date descending to ensure newest date is last
  df <- df %>% arrange(desc(Date))
  
  # Retrieve the first row (most recent date) from df
  df <- df[1, ]  # Assuming df has been sorted by Date in descending order
  
  # Check if data has more than one row (not necessary here since we are dealing with only one row)
  
  # Compute lag based on the arranged order
  previous_week <- lag(df$TotalActivity)
  
  # Calculate changes and percentages
  previous_week_change <- df$TotalActivity - previous_week
  previous_week_change_percent <- (previous_week_change / previous_week) * 100
  avg_activity_last_year <- mean(df$TotalActivity) / mean(df$TotalActivity - 52)
  
  # Format sentences
  sentences <- list(
    paste("For the w/e", format(df$Date, "%d/%m/%Y"), ", the total activity was", 
          format(df$TotalActivity, big.mark = ",", scientific = FALSE), "."),
    paste("The number of patients waiting over 6 weeks increased by", 
          format(previous_week_change, big.mark = ","), "to", 
          format(df$TotalActivity, big.mark = ","), ". Over 6-week wait, performance increased by", 
          ifelse(is.na(previous_week_change_percent), "NA", paste(round(previous_week_change_percent, 1), "%")),
          "to", 
          ifelse(is.na(avg_activity_last_year), "NA", paste(round(avg_activity_last_year, 1), "%")), "."),
    paste("Activity reduced by", 
          format(previous_week_change, big.mark = ","), 
          "to", 
          format(df$TotalActivity, big.mark = ","), 
          "from the previous week. The 4-week average activity was",
          ifelse(is.na(avg_activity_last_year), "NA", paste(round(avg_activity_last_year, 1), "%")),
          "compared to last year (same week).")
  )
  
  return(sentences)
}

# Generate sentences for the most recent date
sentences_list <- generate_sentences(aggregate_data)

print(sentences_list)



```

```{r}
Presentation %>%
  print(target = paste0('output/diagnostic_report_data_', params$report_date, '.pptx'))

```



# Closing the Sandpit connection

```{r}

# dbDisconnect(con)

```


## Reference information

```{r echo=FALSE, eval = FALSE}

layouts <- layout_summary(template_presentation)

print_placeholders <- function(layout_name, master_name){
  placeholders <- layout_properties(template_presentation, layout = layout_name, master = master_name)
  print(paste("PLaceholders:", layout_name, master_name))
  print(placeholders)
}

walk2(.x = layouts$layout, .y = layouts$master, ~print_placeholders(.x, .y))

layout_properties(template_presentation, layout = "Two Columns Style 1", master = "Content Slide White")

#ggsave('review.png', plot)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
